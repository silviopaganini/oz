function sendToJavaScript(e,t,s){SCSound.receive(e,t,s)}var SCSound={isReady:!1,webaudio:!1,debug:!1,doLog:!1,self:this,dummyConsole:{log:function(){}},log:this.dummyConsole,initialize:function(e,t,s,n,o,i){SCSound.progress=o,SCSound.callback=n,SCSound.xmlPath=e,SCSound.soundPath=t,SCSound.swfLink=s,SCSound.libLoaded=i;SCSound.doLog&&void 0!==window.console?(SCSound.console=window.console,SCSound.console.log("scsound log mode")):SCSound.console=SCSound.dummyConsole,"undefined"!=typeof AudioContext?(SCSound.webaudio=!0,SCSound.initWebAudio()):SCSound.webaudio=!1},initFlash:function(){var e=document.createElement("div");if(e.setAttribute("id","soundcontroller"),document.body.appendChild(e),swfobject.hasFlashPlayerVersion("9.0.0")){var t={scDeployPath:SCSound.swfLink+"SCDeploy.swf",configXmlPath:SCSound.xmlPath,soundFolderPath:SCSound.swfLink},s={allowScriptAccess:"always"},n={id:"soundcontroller"};swfobject.embedSWF(SCSound.swfLink+"scjs.swf","soundcontroller","1","1","9.0.0","",t,s,n,function(e){SCSound.flashEmbeddedHandler(e.success)})}else SCSound.console.log("Flash not available"),SCSound.callback(!1)},initWebAudio:function(){SCSound.Core.EventBus=new SCSound.Core.EventBusClass,SCSound.htmlAudio=!0,SCSound.Core.EventBus.addEventListener("SCLoadProgress",function(e,t){SCSound.receive("scsound_progress",t,"sounds_0.swf")},self),SCSound.Core.EventBus.addEventListener("scsound_complete",function(e,t,s){SCSound.receive("scsound_complete",t,s)},self),SCSound.sc=new SCSound.Core.SoundController(SCSound.xmlPath,SCSound.soundPath,function(){if(SCSound.receive("scsound_ready",1,""),SCSound.debug){var e=document.getElementsByTagName("head")[0],t=document.createElement("script");t.type="text/javascript",t.src="scdebug.js",t.onload=function(){scdebug.init()},e.appendChild(t)}})},flashEmbeddedHandler:function(e){e?SCSound.hasSWF=!0:SCSound.callback(!1)},send:function(e,t){SCSound.webaudio?SCSound.sc.trig(e,t):SCSound.hasSWF&&swfobject.hasFlashPlayerVersion("9.0.0")&&(void 0===t?document.getElementById("soundcontroller").sendToActionScript(e):document.getElementById("soundcontroller").sendToActionScript(e,t))},setListenerPosition:function(e,t,s,n,o,i,a,r,u,d,h,l){if(SCSound.webaudio)if(SCSound.sc.setListenerPosition(e,t,s,n,o,i,a,r,u,d,h,l),t>20&&t<22){var c=(e-70)/40;c<0&&(c=0),c>1&&(c=1),c=Math.abs(c-1),SCSound.sc.setEffectParam("carnival","filter","frequency",2e4*c+350,0),SCSound.sc.setEffectParam("organ","organfilter","frequency",2e4*c+350,0),SCSound.sc.setBusVolume("market1",.5*c,0),SCSound.sc.setBusVolume("market2",.5*c,0)}else if(e>-100&&e<0){var f=(e+100)/100;f<0&&(f=0),f>1&&(f=1),SCSound.sc.setBusVolume("insidetornado",f,0)}},setPannerPosition:function(e,t,s,n,o,i,a,r,u,d,h,l,c){},receive:function(e,t,s){if(SCSound.hasSWF=!0,"scsound_ready"!=e&&"soundcontroller_loaded"!=e||(SCSound.isReady=!0,SCSound.callback(!0)),"scsound_progress"==e&&"sounds_0.swf"==s&&SCSound.progress(t),"scsound_complete"==e){var n=s.split("sounds_")[1].split(".swf")[0];SCSound.libLoaded&&(SCSound.libLoaded(n),SCSound.console.log("Sounds loaded:",n))}}};SCSound.Core={},SCSound.Core.SoundController=function(e,t,s){this.initCallback=s,this.xmlPath=e,this.init(),this.soundPath=t},SCSound.Core.SoundController.prototype={init:function(){this.context=new AudioContext,this.listener=this.context.listener,this.master=this.context.createGain(),this.compressor=this.context.createDynamicsCompressor(),this.startVolume=1,this.master.gain.value=this.startVolume,this.master.connect(this.context.destination),this.groups={},this.sounds={},this.arrangements={},this.bufferList={},this.soundObjects={},this.soundNames=[],this.eventTriggers={},this.busses={},this.total0=4949171,this.total=[176922,1679587,91098,330292,1649765,337167],this.totalLoaded=0,this.autoload={},this.loadXML(),SCSound.Core.SoundController.bufferList=this.bufferList,SCSound.Core.SoundController.context=this.context,SCSound.Core.SoundController.master=this.master,SCSound.Core.SoundController.compressor=this.compressor,SCSound.Core.busses=this.busses},loadXML:function(){var e,t=this;(e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){if(4==e.readyState&&200==e.status){var s=e.responseXML;t.parseXML(s)}},e.open("GET",t.xmlPath,!0),e.send()},parseXML:function(e){for(var t=this,s=e.getElementsByTagName("file"),n=0;n<s.length;n++){var o=s[n].childNodes[0].nodeValue.split("."),i=s[n].getAttribute("autoload"),a=(A=o[0].split("sounds_"))[1];"1"==i?(t.autoload[a]=!0,t.autoSwfNr=a):t.autoload[a]=!1}for(var r=e.getElementsByTagName("bus"),u=0;u<r.length;u++){var d={name:r[u].getAttribute("name"),parent:r[u].getAttribute("parent"),volume:r[u].getAttribute("volume"),panX:r[u].getAttribute("pan"),panY:r[u].getAttribute("panY"),panZ:r[u].getAttribute("panZ"),group:r[u].getAttribute("groupName")};null==d.panX?d.pan=!1:(d.pan=!0,null==d.panY&&(d.panY=0),null==d.panZ&&(d.panZ=0));var h=new SCSound.Core.Bus(d.name,d.volume,d.parent,d.panX,d.panY,d.panZ,d.pan,d.group);t.busses[d.name]=h}var l=e.getElementsByTagName("group");if(l.length>0)for(var c=0;c<l.length;c++){for(var o=l[c].getAttribute("name"),f=l[c].getElementsByTagName("volume")[0].childNodes[0].nodeValue,g=[],S=[],p=l[c].getElementsByTagName("effect"),m=0;m<p.length;m++){var C={};if(p[m].getElementsByTagName("param").length>0){C.effectId=p[m].getAttribute("id"),C.effectInstance=p[m].getAttribute("instance"),C.effectType=p[m].getAttribute("type"),C.params={};for(var b=p[m].getElementsByTagName("param"),v=0;v<b.length;v++){var y=b[v].getAttribute("key"),N=b[v].getAttribute("value");C.params[y]=N}"insert"==C.effectType?g.push(C):"send"==C.effectType&&S.push(C)}}var T=new SCSound.Core.Group(f,g,S);t.groups[o]=T}for(var O=e.getElementsByTagName("soundData")[0].childNodes,A=0;A<O.length;A++)if("sound"==O[A].nodeName){var o=O[A].getElementsByTagName("name")[0].childNodes[0].nodeValue,x=O[A].getElementsByTagName("length")[0].childNodes[0].nodeValue,m=null;m=O[A].getElementsByTagName("load")[0]?O[A].getElementsByTagName("load")[0].childNodes[0].nodeValue:null;var B=t.autoSwfNr;m&&(B=m);var k;if(x.indexOf(",")>-1){var P=x.split(",");k=t.beatToMilliseconds(P[0],P[1])/1e3}else k=x/1e3;var j=!1,E=0,V=0,L=null;O[A].getElementsByTagName("start")[0]&&(E=parseFloat(O[A].getElementsByTagName("start")[0].childNodes[0].nodeValue)/1e3,V=parseFloat(O[A].getElementsByTagName("duration")[0].childNodes[0].nodeValue)/1e3,L=O[A].getElementsByTagName("src")[0].childNodes[0].nodeValue,j=!0),t.soundNames.push(o),(ce=new SCSound.Core.Sound(o,k,"")).load=B,ce.audioSprite=j,j&&(ce.start=E/44.1,ce.source=L,ce.duration=V/44.1-.024),t.sounds[o]=ce}else if("soundObject"==O[A].nodeName){var o=O[A].getElementsByTagName("name")[0].childNodes[0].nodeValue,R=O[A].getElementsByTagName("mode")[0].childNodes[0].nodeValue,f=O[A].getElementsByTagName("volume")[0].childNodes[0].nodeValue,w=(O[A].getElementsByTagName("pan")[0].childNodes[0].nodeValue,O[A].getElementsByTagName("loop")[0].childNodes[0].nodeValue),q="";O[A].getElementsByTagName("groupName").length>0&&(q=O[A].getElementsByTagName("groupName")[0].childNodes[0].nodeValue);var M,I;O[A].getElementsByTagName("min").length>0&&(M=O[A].getElementsByTagName("min")[0].childNodes[0].nodeValue,I=O[A].getElementsByTagName("max")[0].childNodes[0].nodeValue);for(var F=O[A].getElementsByTagName("parentBus")[0].childNodes[0].nodeValue,_=[],X=[],G=!1,D=0,U=O[A].getElementsByTagName("sound"),Y=0;Y<U.length;Y++){var Z,H=U[Y].childNodes[0].nodeValue,W=U[Y].getAttribute("offset");if(W.indexOf(",")>-1){var Q=W.split(",");Z=t.beatToMilliseconds(Q[0],Q[1])/1e3}else Z=W/1e3;Z<0&&(G=!0,Z<D&&(D=Z)),_.push(H),X.push(Z)}(ee=new SCSound.Core.SoundObject([],X)).hasUpbeat=G,ee.upbeatTime=D,ee.soundNames=_,ee.name=o,ee.mode=R,"top"===f.toLowerCase()&&(f=1),ee.volume=parseFloat(f),ee.gainNode.gain.value=ee.volume,ee.parentBus=F,ee.loop="1"==w,q&&(ee.group=t.groups[q]),M&&(ee.min=M,ee.max=I),t.soundObjects[o]=ee}else if("arrangement"==O[A].nodeName){for(var o=O[A].getElementsByTagName("name")[0].childNodes[0].nodeValue,z=O[A].getElementsByTagName("domain")[0].childNodes[0].nodeValue,J=[],K=O[A].getElementsByTagName("soundObject"),$=0;$<K.length;$++){var ee=K[$].childNodes[0].nodeValue;J.push(ee)}var te=new SCSound.Core.Arrangement(o,z);te.soundObjectNames=J,t.arrangements[o]=te}for(var se=e.getElementsByTagName("action"),ne=0;ne<se.length;ne++){for(var oe=se[ne].getElementsByTagName("event")[0].childNodes[0].nodeValue,ie={event:oe},ae=[],re=se[ne].getElementsByTagName("target"),ue=0;ue<re.length;ue++){for(var de={action:re[ue].getAttribute("id")},he=[],le=re[ue].getElementsByTagName("arg"),ce=0;ce<le.length;ce++)if(le[ce].getAttribute("id")){var y=le[ce].getAttribute("key"),fe=le[ce].getAttribute("value");void 0==he[y]?(he[y]=[],he[y].push(fe)):he[y].push(fe)}else{var y=le[ce].getAttribute("key"),fe=le[ce].getAttribute("value");he[y]=fe}de.args=he,ae.push(de)}ie.targets=ae,t.eventTriggers[oe]=ie}var ge=!1;for(var m in t.autoload)t.autoload[m]&&(ge=!0,t.loadSounds(0,"auto"));ge||t.initSC("auto")},loadSounds:function(e,t){var s,n=this;if(e!=n.soundNames.length){if(n.sounds[n.soundNames[e]].audioSprite)return void n.loadSounds(e+1,t);if("stream"==n.sounds[n.soundNames[e]].load){var o=new Audio;return o.src=this.soundPath+n.soundNames[e]+".mp3",o.preload="none",n.bufferList[n.soundNames[e]]=o,void n.loadSounds(e+1,t)}if("auto"==t&&0==n.autoload[n.sounds[n.soundNames[e]].load])return void n.loadSounds(e+1,t);if("auto"!=t&&t!=n.sounds[n.soundNames[e]].load)return void n.loadSounds(e+1,t);s=n.sounds[n.soundNames[e]].load;var i=n.soundPath+n.soundNames[e]+".mp3",a=new XMLHttpRequest;a.open("GET",i,!0),a.responseType="arraybuffer",a.addEventListener("progress",function(e){if(e.lengthComputable){var t=(n.totalLoaded+e.loaded)/n.total[s];e.loaded/e.total==1&&(n.totalLoaded+=e.loaded,SCSound.console.log(n.totalLoaded)),SCSound.Core.EventBus.dispatch("SCLoadProgress",this,t)}},!1),a.onload=function(){var s,o;n.context.decodeAudioData(a.response,function(i){o=i,s=n.soundNames[e].split("."),n.bufferList[s[0]]=o,n.loadSounds(e+1,t)},function(){console.log("Decoding the audio buffer failed")})},a.send()}else{n.initSC(t);var r="sounds_"+t+".swf";"auto"==t&&(r="sounds_"+n.autoSwfNr+".swf"),n.totalLoaded=0,SCSound.Core.EventBus.dispatch("scsound_complete",this,1,r)}},initSC:function(e){for(var t in this.sounds)this.sounds[t].audioBuffer||this.sounds[t].audioSprite||(this.sounds[t].audioBuffer=this.bufferList[this.sounds[t].name]);for(var s in this.soundObjects)if(!((a=this.soundObjects[this.soundObjects[s].name]).sounds.length>0&&(a.sounds[0].audioBuffer||this.sounds[t].audioSprite))){a.sounds=[];for(s=0;s<a.soundNames.length;s++){var n=SCSound.Core.copy(this.sounds[a.soundNames[s]],"Sound");n.parentSO=a,a.sounds.push(n)}}for(var o in this.arrangements){var i=this.arrangements[this.arrangements[o].name];if(!(i.soundObjects.length>0&&(i.soundObjects[0].sounds[0].audioBuffer||i.soundObjects[0].sounds[0].audioSprite))){i.soundObjects=[];for(s=0;s<i.soundObjectNames.length;s++){var a=SCSound.Core.copy(this.soundObjects[i.soundObjectNames[s]],"SoundObject");i.soundObjects.push(a)}i.soundObjects.sort(function(e,t){return e.upbeatTime-t.upbeatTime})}}if("auto"==e){for(var r in this.busses)"_MasterBus"==this.busses[r].name||"_MasterBus"==this.busses[r].parent?this.busses[r].gainNode.connect(SCSound.Core.SoundController.master):"_MasterBus"==this.busses[r].parent?this.busses[r].gainNode.connect(this.busses[this.busses[r].parent].gainNode):this.busses[r].group?this.busses[this.busses[r].parent].pan?(this.busses[r].gainNode.connect(this.groups[this.busses[r].group].firstNode),this.groups[this.busses[r].group].lastNode.connect(this.busses[this.busses[r].parent].panner)):(this.busses[r].gainNode.connect(this.groups[this.busses[r].group].firstNode),this.groups[this.busses[r].group].lastNode.connect(this.busses[this.busses[r].parent].gainNode)):this.busses[this.busses[r].parent].pan?this.busses[r].gainNode.connect(this.busses[this.busses[r].parent].panner):this.busses[r].gainNode.connect(this.busses[this.busses[r].parent].gainNode);for(var u in this.groups)this.groups[u].hasReverb&&(this.groups[u].hasReverb.buffer=this.bufferList[this.groups[u].reverbFile]);this.initCallback()}},trig:function(e,t){if(SCSound.console.log(e,t),!this.eventTriggers[e])return!1;for(var s=this.eventTriggers[e].targets,n=0;n<s.length;n++)switch(s[n].action){case"PlayArrAction":o=0;s[n].args.delay&&(o=s[n].args.delay),this.playArr(s[n].args.name,!0,!1,o);break;case"StartSOAction":var o=0;s[n].args.delay&&(o=s[n].args.delay),this.playSO(s[n].args.name,o);break;case"PlaySOAction":for(var i=this.getCurrentArrangements(),a=0,r=0;r<i.length;r++)(g=i[r]).domain==s[n].args.domain&&(a=g.getNextClipPoint());this.soundObjects[s[n].args.name].play(SCSound.Core.SoundController.context.currentTime+a,0,0);break;case"StopSOAction":this.stopSO(s[n].args.name,!0);break;case"FadeAndStopDomainAction":this.fadeAndStopDomain(s[n].args.name,s[n].args.fadeOutTime);break;case"BusVolumeAction":this.setBusVolume(s[n].args.name,s[n].args.vol,s[n].args.time);break;case"BusPanAction":this.setBusPan(s[n].args.name,s[n].args.time,s[n].args.pan,s[n].args.panY,s[n].args.panZ);break;case"SetBusVolumeAction":t<0&&(t=Math.abs(t)),(t*=40)>1&&(t=1),this.setBusVolume(s[n].args.name,t,0);break;case"SetBusPanAction":s[n].args.divide&&(t/=s[n].args.divide),this.setBusPan(s[n].args.name,0,t,0,1);break;case"LoadSWFAction":var u=s[n].args.name.split(".")[0].split("sounds_")[1];this.loadSounds(0,u);break;case"PlayRandomArrAction":for(var d=s[n].args.name,h=Math.floor(Math.random()*d.length),i=this.getCurrentArrangements(),r=0;r<i.length;r++){"main"==(g=i[r]).domain&&(l=g.name)}l==d[h]&&(h=(h+1)%d.length),"StartGame"==l&&(h=0),this.playArr(d[h],!1,!1,0);break;case"ReplaceRandomArrAction":for(var i=this.getCurrentArrangements(),a=0,r=0;r<i.length;r++){var l;"main"==(g=i[r]).domain&&(l=g.name)}var d=s[n].args.name,h=Math.floor(Math.random()*d.length);this.playArr(d[h],!1,!0,0);break;case"StopArrAction":this.stopArr(s[n].args.name,!0);break;case"SetPlaybackRateAction":this.arrangements[s[n].args.name].setPlaybackRate(t);break;case"EffectParamAction":var c;c="val"==s[n].args.value?t:s[n].args.value,s[n].args.factor&&(c*=s[n].args.factor),this.setEffectParam(s[n].args.group,s[n].args.name,s[n].args.param,c,s[n].args.time/1e3);break;case"UltimateUpbeatAction":for(var f=this.soundObjects[s[n].args.name],i=this.getCurrentArrangements(),a=0,r=0;r<i.length;r++){var g=i[r];g.domain==s[n].args.domain&&(a=g.getNextClipPoint())}for(var S=f.offsets.length-1,p=-1;Math.abs(f.offsets[S])<a&&(p=S,-1!=--S););p>-1&&f.play(SCSound.Core.SoundController.context.currentTime+a-f.sounds[p].length,p,0);break;case"PauseArrAction":this.pauseArr(s[n].args.name);break;case"ResumeArrAction":this.resumeArr(s[n].args.name);break;default:SCSound.console.log("No actions for",s[n].action)}},beatToMilliseconds:function(e,t){return 60/e*t*1e3},playSO:function(e,t){this.soundObjects[e].play(SCSound.Core.SoundController.context.currentTime,0,t)},stopSO:function(e,t){this.soundObjects[e].stop(t)},setSOVolume:function(e,t,s){s?this.soundObjects[e].gainNode.gain.setTargetValueAtTime(t,0,s):(this.soundObjects[e].gainNode.gain.cancelScheduledValues(0),this.soundObjects[e].gainNode.gain.value=t)},setSOPlaybackRate:function(e,t){this.soundObjects[e].setPlaybackRate(t)},playArr:function(e,t,s,n){for(var o=0,i=this.getCurrentArrangements(),a=0,r=0;r<i.length;r++){var u=i[r];u.name!=e&&(u.domain==this.arrangements[e].domain&&(s&&(a=u.getNextId()),o=u.stop(!1)))}n>0&&(o=n/1e3),this.arrangements[e].play(o,a,t)},replaceArr:function(e,t){void 0==t&&(forceupbeat=!1);for(var s=0,n=this.getCurrentArrangements(),o=0;o<n.length;o++){var i=n[o];if(i.name!=e){var a=0;i.domain==this.arrangements[e].domain&&(a=i.getNextId(),s=i.stop(!1))}}this.arrangements[e].play(s,a,t)},stopArr:function(e,t){return this.arrangements[e].stop(t)},pauseArr:function(e){this.arrangements[e].pause()},resumeArr:function(e){this.arrangements[e].resume()},fadeAndStopDomain:function(e,t){for(var s,n=this.getCurrentArrangements(),o=0;o<n.length;o++)e==n[o].domain&&(s=n[o]);if(s){for(var i=0;i<s.soundObjects.length;i++)s.soundObjects[i].gainNode.gain.linearRampToValueAtTime(s.soundObjects[i].volume,this.context.currentTime),s.soundObjects[i].gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime+t/1e3);setTimeout(function(){s.stop(!0);for(var e=0;e<s.soundObjects.length;e++)s.soundObjects[e].gainNode.gain.cancelScheduledValues(0),s.soundObjects[e].gainNode.gain.value=s.soundObjects[e].volume},t)}},setBusPan:function(e,t,s,n,o){n=void 0===n?this.busses[e].panY:n,o=void 0===o?this.busses[e].panZ:o,this.busses[e].panner.setPosition(s,n,o),this.busses[e].panX=s,this.busses[e].panY=n,this.busses[e].panZ=o},setPannerPosition:function(e,t,s,n,o,i,a,r,u,d,h,l,c){if(this.busses[e]){var f=this.busses[e];f.panner.setPosition(t,s,n)}},setListenerPosition:function(e,t,s,n,o,i,a,r,u,d,h,l){this.listener.setPosition(e,t,s)},setBusVolume:function(e,t,s){s>0?(this.busses[e].gainNode.gain.linearRampToValueAtTime(this.busses[e].gainNode.gain.value,this.context.currentTime),this.busses[e].gainNode.gain.linearRampToValueAtTime(t,this.context.currentTime+s/1e3)):(this.busses[e].gainNode.gain.cancelScheduledValues(0),this.busses[e].gainNode.gain.value=t)},setMasterVolume:function(e){this.master.gain.value=e},setEffectParam:function(e,t,s,n,o){"frequency"==s&&(n<20&&(n=20),o?(this.groups[e].effects[t].fx.frequency.linearRampToValueAtTime(this.groups[e].effects[t].fx.frequency.value,this.context.currentTime),this.groups[e].effects[t].fx.frequency.exponentialRampToValueAtTime(n,o+this.context.currentTime)):this.groups[e].effects[t].fx.frequency.setValueAtTime(n,this.context.currentTime)),"Q"==s&&(o?this.groups[e].effects[t].fx.Q.setTargetValueAtTime(n,0,o):(this.groups[e].effects[t].fx.Q.value.cancelScheduledValues(0),this.groups[e].effects[t].fx.Q.value=n)),"delayTime"==s&&(o?this.groups[e].effects[t].fx.delayTime.setTargetValueAtTime(n,0,o):(this.groups[e].effects[t].fx.delayTime.value.cancelScheduledValues(0),this.groups[e].effects[t].fx.delayTime.value=n)),"wet"==s&&(this.groups[e].effects[t].effectNode.gain.value=n),"sendVol"==s&&(o?this.groups[e].effects[t].send.gain.setTargetValueAtTime(n,0,o):(this.groups[e].effects[t].send.gain.cancelScheduledValues(0),this.groups[e].effects[t].send.gain.value=n)),"volume"==s&&(o?this.groups[e].lastNode.gain.setTargetValueAtTime(n,0,o):(this.groups[e].lastNode.gain.cancelScheduledValues(0),this.groups[e].lastNode.gain.value=n))},getCurrentArrangements:function(){var e=[];for(var t in this.arrangements){var s=this.arrangements[t];s.isPlaying&&e.push(s)}return e},stopCurrentArrangements:function(e){for(var t=this.getCurrentArrangements(),s=0;s<t.length;s++)var n=t[s].stop(e);return n}},SCSound.Core.copy=function(e,t){var s;"Sound"==t?s=new SCSound.Core.Sound(e.name,e.length,e.parent):"SoundObject"==t&&(s=new SCSound.Core.SoundObject(e.soundNames,e.offsets));for(var n in e)s[n]=e[n];return s},SCSound.Core.Arrangement=function(e,t){this.name=e,this.domain=t,this.soundObjectNames=[],this.isPlaying=!1,this.soundObjects=[],this.hasListener=!1,this.stoppedSos={},this.stoppedSosCount=0},SCSound.Core.Arrangement.prototype={play:function(e,t,s){if(t||(t=0),s||(s=!1),!this.isPlaying){this.isPlaying=!0;for(var n=0,o=0;o<this.soundObjects.length;o++)this.soundObjects[o].hasUpbeat&&this.soundObjects[o].upbeatTime<n&&(n=this.soundObjects[o].upbeatTime);for(var i=!1,a=0;a<this.soundObjects.length;a++)n<0?this.soundObjects[a].hasUpbeat&&this.soundObjects[a].upbeatTime==n?0==e||s?(i=!0,this.soundObjects[a].play(SCSound.Core.SoundController.context.currentTime+e,t)):n>e&&(i=!1,this.soundObjects[a].play(SCSound.Core.SoundController.context.currentTime+e,t)):i?this.soundObjects[a].play(SCSound.Core.SoundController.context.currentTime+e+Math.abs(n),t):this.soundObjects[a].play(SCSound.Core.SoundController.context.currentTime+e,t):this.soundObjects[a].play(SCSound.Core.SoundController.context.currentTime+e,t),SCSound.Core.EventBus.addEventListener(this.soundObjects[a].name+"_stopped",this.soStopped,this)}},soStopped:function(e){this.stoppedSos[e.target.type]||(this.stoppedSos[e.target.type]=!0,++this.stoppedSosCount==this.soundObjects.length&&(this.isPlaying=!1,this.stoppedSos={},this.stoppedSosCount=0))},stop:function(e){if(this.getNextId(),0==this.isPlaying)return 0;this.isPlaying=!1;for(var t=0,s=0;s<this.soundObjects.length;s++){var n=this.soundObjects[s].stop(e);n>t&&(t=n)}return this.stoppedSos={},this.stoppedSosCount=0,t},pause:function(){for(var e=0;e<this.soundObjects.length;e++)this.soundObjects[e].pause()},resume:function(){for(var e=0;e<this.soundObjects.length;e++)this.soundObjects[e].resume()},getNextClipPoint:function(){if(0==this.isPlaying)return 0;for(var e=0,t=0;t<this.soundObjects.length;t++){var s=this.soundObjects[t].getNextClipPoint();s>e&&(e=s)}return e},getNextId:function(){for(var e=0,t=0;t<this.soundObjects.length;t++)if(!this.soundObjects[t].hasUpbeat){var s=this.soundObjects[t].getNextId();s>e&&(e=s)}return e},setPlaybackRate:function(e){this.playbackRate=e;for(var t=0;t<this.soundObjects.length;t++)this.soundObjects[t].setPlaybackRate(this.playbackRate)}},SCSound.Core.SoundObject=function(e,t){this.soundNames=e,this.offsets=t,this.loop=!0,this.mode="pattern",this.volume=1,this.upbeatTime=0,this.isPlaying=!1,this.sounds=[],this.gainNode=SCSound.Core.SoundController.context.createGain(),this.gainNode.gain.value=this.volume,this.adder=0,this.stepFlag=0,this.skippedOffset=0,this.startId=0,this.nextSound=0,this.currentSound=-1,this.hasStarted=!1,this.queuedSounds=[],this.queuedRounds=-1,this.startTime=0,this.soStartTime=0,this.soStartId=0,this.isChecking=!1,this.playbackRate=1},SCSound.Core.SoundObject.prototype={play:function(e,t,s,n){if(this.offsetSound=n,this.offsetSound||(this.offsetSound=0),t||(t=0),this.totalLength=this.offsets[this.offsets.length-1]+this.sounds[this.sounds.length-1].length,this.startId=t,this.isPlaying||(this.soStartTime=e,this.soStartId=t),this.isPlaying=!0,"pattern"==this.mode){this.startTime=e;o=t%this.sounds.length;this.skippedOffset=this.offsets[o];for(a=o;a<this.sounds.length;a++){d=SCSound.Core.copy(this.sounds[a],"Sound");this.queuedSounds.push(d),this.queuedSounds[this.queuedSounds.length-1].play(this.offsets[a]-this.skippedOffset+e,this.group,this.gainNode,!1,this.offsetSound)}this.queuedRounds++,this.isChecking||(this.isChecking=!0,this.intervalId=setInterval(this.checkRound.bind(this),100))}else if("patternsingle"==this.mode){this.startTime=e;o=t%this.sounds.length;this.skippedOffset=this.offsets[o];d=this.sounds[o];this.queuedSounds.push(d),this.queuedSounds[this.queuedSounds.length-1].play(this.offsets[o]-this.skippedOffset+e,this.group,this.gainNode,!1,this.offsetSound)}else if("steptrig"==this.mode)this.sounds[this.adder%this.sounds.length].play(e+s/1e3,this.group,this.gainNode,!1,this.offsetSound),this.adder++;else if("randomtrig"==this.mode){this.adder=Math.floor(Math.random()*this.sounds.length),this.adder<1&&(this.adder=1),this.stepFlag+=this.adder;var o=this.stepFlag%this.sounds.length;this.sounds[o].play(e+s/1e3,this.group,this.gainNode,!1,this.offsetSound)}else if("randompatternamb"==this.mode){this.startTime=e,this.sounds=this.shuffleArray(this.sounds);for(var i=0,a=0;a<this.sounds.length;a++){d=SCSound.Core.copy(this.sounds[a],"Sound");this.queuedSounds.push(d);var r=i+this.min/1e3+Math.random()*this.max/1e3;i=r,this.queuedSounds[this.queuedSounds.length-1].play(r+e,this.group,this.gainNode,!1,this.offsetSound)}this.queuedRounds++;var u=this.min/1e3+Math.random()*this.max/1e3+(i+this.sounds[this.sounds.length-1].length);this.intervalId=setTimeout(this.play.bind(this,u+e),1e3*u)}else if("loop"==this.mode){var d=SCSound.Core.copy(this.sounds[0],"Sound");this.queuedSounds.push(d),this.queuedSounds[0].play(e,this.group,this.gainNode,!0,this.offsetSound)}},shuffleArray:function(e){for(var t,s,n=e.length;n;t=parseInt(Math.random()*n),s=e[--n],e[n]=e[t],e[t]=s);return e},setPlaybackRate:function(e){this.playbackRate=e;for(var t=0;t<this.queuedSounds.length;t++)3!=this.queuedSounds[t].voice.playbackState&&this.queuedSounds[t].setPlaybackRate(this.playbackRate)},checkRound:function(){this.loop?SCSound.Core.SoundController.context.currentTime-this.soStartTime>this.totalLength*this.queuedRounds&&this.doLoop():SCSound.Core.SoundController.context.currentTime-this.soStartTime>this.totalLength&&(SCSound.Core.EventBus.dispatch(this.name+"_stopped",this),this.isPlaying=!1,this.resetStuff())},doLoop:function(){var e=this.startTime+this.totalLength-this.skippedOffset;this.play(e,0,0)},pause:function(){this.isPlaying=!1,this.pauseTime=SCSound.Core.SoundController.context.currentTime-this.soStartTime+this.offsetSound;for(var e=0;e<this.queuedSounds.length;e++)this.queuedSounds[e].stop(!0);this.resetStuff()},resume:function(){this.play(SCSound.Core.SoundController.context.currentTime,0,0,this.pauseTime)},stop:function(e){if(this.isPlaying=!1,e)for(s=0;s<this.queuedSounds.length;s++)this.queuedSounds[s].stop(e);else for(var t=this.getNextClipPoint(),s=0;s<this.queuedSounds.length;s++)1==this.queuedSounds[s].voice.playbackState&&this.queuedSounds[s].stop(e);return this.resetStuff(),this.hasUpbeat&&currentSOTime>this.sounds[0].length?t=0:this.hasUpbeat&&currentSOTime<this.sounds[0].length&&(t=this.sounds[0].length-currentSOTime),t},getNextClipPoint:function(){if(this.hasUpbeat)return 0;for(var e=0,t=SCSound.Core.SoundController.context.currentTime-this.soStartTime,s=this.offsets[this.offsets.length-1]+this.sounds[this.sounds.length-1].length,n=0;t>s*n;)n++;for(var o=t-s*(n-1),i=0;i<this.offsets.length;i++)if(o>=this.offsets[i]-this.skippedOffset&&o<this.offsets[i]-this.skippedOffset+this.sounds[i].length){var a=o-(this.offsets[i]-this.skippedOffset);e=this.sounds[i].length-a}return e},getPlayingSound:function(){for(var e,t=0;t<this.queuedSounds.length;t++)if(2==this.queuedSounds[t].voice.playbackState){e=this.queuedSounds[t];break}return e},resetStuff:function(){clearInterval(this.intervalId),this.isChecking=!1,this.queuedSounds=[],this.queuedRounds=-1,this.currentSound=-1,this.nextSound=0,this.hasStarted=!1},getNextId:function(){if(this.hasUpbeat)return-1;for(var e=SCSound.Core.SoundController.context.currentTime-this.soStartTime,t=0,s=0;s<this.offsets.length;s++)e>=this.offsets[s]-this.skippedOffset&&e<this.offsets[s]-this.skippedOffset+this.sounds[s].length&&(t=(s+1+this.soStartId)%this.sounds.length);return t}},SCSound.Core.Sound=function(e,t,s){this.name=e,this.length=t,this.parentSO=s,this.playbackRate=1,this.isPlaying=!1},SCSound.Core.Sound.prototype={play:function(e,t,s,n,o){this.isPlaying=!0,this.playbackRate=this.parentSO.playbackRate;var i=!1,a=0,r=0;if(this.voice=SCSound.Core.SoundController.context.createBufferSource(),this.audioBuffer||this.audioSprite){if(this.audioSprite){if(this.audioBuffer=SCSound.sc.bufferList[this.source],!this.audioBuffer)return void SCSound.console.log("sound",this.source,"not loaded");this.audio=this.voice,this.audio.buffer=this.audioBuffer,this.audio.playbackRate.value=this.playbackRate,a=this.start+o,r=this.duration-o,n&&(this.audio.loop=!0)}else if(this.audioBuffer.gain)this.audio=this.voice,this.audio.buffer=this.audioBuffer,this.audio.playbackRate.value=this.playbackRate,a=o,n&&(this.audio.loop=!0);else{if(this.audioBuffer.gain)return void SCSound.console.log("Unrecognized sound type",this.name);i=!0,this.mediaElement||(this.mediaElement=this.audioBuffer,this.audio=SCSound.Core.SoundController.context.createMediaElementSource(this.mediaElement)),n&&(this.mediaElement.loop=!0)}this.audio.connect(s);var u=s;SCSound.Core.busses[this.parentSO.parentBus].pan?u.connect(SCSound.Core.busses[this.parentSO.parentBus].panner):u.connect(SCSound.Core.busses[this.parentSO.parentBus].gainNode),i?this.mediaElement.play():this.audioSprite?this.voice.start?this.voice.start(e,a,r):this.voice.noteGrainOn(e,a,r):e>=SCSound.Core.SoundController.context.currentTime-.2&&(this.voice.start?this.voice.start(e,a,this.audioBuffer.duration-a):this.voice.noteGrainOn(e,a,this.audioBuffer.duration-a))}else SCSound.console.log("sound",this.name,"not loaded")},setPlaybackRate:function(e){this.voice&&(this.playbackRate=e,this.voice.playbackRate.value=this.playbackRate)},stop:function(e){this.voice&&(this.isPlaying&&this.voice.stop(0),this.isPlaying=!1,this.mediaElement&&this.mediaElement.pause())}},SCSound.Core.Group=function(e,t,s){this.inserts=t,this.sends=s,this.effects={},this.lastNode=SCSound.Core.SoundController.context.createGain(),this.lastNode.gain.value=e,this.firstNode=SCSound.Core.SoundController.context.createGain(),this.createFX()},SCSound.Core.Group.prototype={createFX:function(){var e=this.firstNode;if(this.inserts.length>0)for(var t=0;t<this.inserts.length;t++){n={};"Biquad"==this.inserts[t].effectId&&(n.fx=SCSound.Core.SoundController.context.createBiquadFilter(),n.fx.type=n.fx[this.inserts[t].params.type],n.fx.frequency.value=this.inserts[t].params.frequency,n.fx.Q.value=this.inserts[t].params.Q,n.fx.gain.value=this.inserts[t].params.gain),e.connect(n.fx),e=n.fx,this.effects[this.inserts[t].effectInstance]=n}if(this.sends.length>0)for(var s=0;s<this.sends.length;s++){var n={};"Convolver"==this.sends[s].effectId?(n.fx=SCSound.Core.SoundController.context.createConvolver(),this.reverbFile=this.sends[s].params.file,this.hasReverb=n.fx,n.send=SCSound.Core.SoundController.context.createGain(),e.connect(n.send),n.send.connect(n.fx),n.fx.connect(SCSound.Core.SoundController.master),n.send.gain.value=1):"Delay"==this.sends[s].effectId&&(n.fx=SCSound.Core.SoundController.context.createDelayNode(),n.fx.delayTime.value=this.sends[s].params.time,n.send=SCSound.Core.SoundController.context.createGain(),e.connect(n.send),n.send.connect(n.fx),n.fx.connect(SCSound.Core.SoundController.master),n.send.gain.value=.5),this.effects[this.sends[s].effectInstance]=n}e.connect(this.lastNode)}},SCSound.Core.Bus=function(e,t,s,n,o,i,a,r){this.name=e,this.volume=t,this.panX=n,this.panY=o,this.panZ=i,this.pan=a,this.group=r,this.parent=s,this.gainNode=SCSound.Core.SoundController.context.createGain(),this.gainNode.gain.value=this.volume,this.pan&&(this.panner=SCSound.Core.SoundController.context.createPanner(),this.panner.panningModel="HRTF",this.panner.refDistance=1,this.panner.setPosition(this.panX,this.panY,i),this.panner.connect(this.gainNode))},SCSound.Core.EventBusClass=function(){this.listeners={}},SCSound.Core.EventBusClass.prototype={addEventListener:function(e,t,s){for(var n=[],o=arguments.length,i=0;i<o;i++)n.push(arguments[i]);n=n.length>3?n.splice(3,n.length-1):[],void 0!==this.listeners[e]?this.listeners[e].push({scope:s,callback:t,args:n}):this.listeners[e]=[{scope:s,callback:t,args:n}]},removeEventListener:function(e,t,s){if(void 0!==this.listeners[e]){for(var n=this.listeners[e].length,o=[],i=0;i<n;i++){var a=this.listeners[e][i];a.scope==s&&a.callback==t||o.push(a)}this.listeners[e]=o}},hasEventListener:function(e,t,s){if(void 0!==this.listeners[e]){for(var n,o=this.listeners[e].length,i=0;i<o;i++){var a=this.listeners[e][i];n=a.scope==s&&a.callback==t}return n}},dispatch:function(e,t){for(var s=0,n={type:e,target:t},o=[],i=arguments.length,a=0;a<i;a++)o.push(arguments[a]);if(o=o.length>2?o.splice(2,o.length-1):[],o=[n].concat(o),void 0!==this.listeners[e])for(var r=this.listeners[e].length,a=0;a<r;a++){var u=this.listeners[e][a];u&&u.callback&&(u.args=o.concat(u.args),u.callback.apply(u.scope,u.args),s+=1)}},getEvents:function(){var e="";for(var t in this.listeners)for(var s=this.listeners[t].length,n=0;n<s;n++){var o=this.listeners[t][n];e+=o.scope&&o.scope.className?o.scope.className:"anonymous",e+=" listen for '"+t+"'\n"}return e}};